name: EA Validation and Build

on:
  push: 
    branches: [ main ]
  pull_request: 
    branches: [ main ]

jobs: 
  build-and-validate: 
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name:  Checkout repo
        uses:  actions/checkout@v4

      # 1) Validate configs (make target now matches Makefile)
      - name: Validate EA configs
        run: |
          if (Get-Command make -ErrorAction SilentlyContinue) {
            make validate
          } else {
            Write-Host "make not found; skipping 'make validate'"
          }

      # 2) Python linting + tests (fail-fast)
      - name: Set up Python
        uses: actions/setup-python@v5
        with: 
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          }

      - name: Run Ruff lint
        run:  ruff check python/ scripts/

      - name: Run pytest
        run: pytest

      # 3) Install MetaTrader 5 (MetaEditor)
      - name: Install MetaTrader 5
        run: |
          # Download MT5 installer
          $installerUrl = "https://download.mql5.com/cdn/web/metaquotes. software.corp/mt5/mt5setup.exe"
          $installerPath = "$env: TEMP\mt5setup.exe"
          
          Write-Host "Downloading MetaTrader 5..."
          Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath
          
          Write-Host "Installing MetaTrader 5..."
          Start-Process -FilePath $installerPath -ArgumentList "/auto" -Wait -NoNewWindow
          
          # Wait for installation to complete
          Start-Sleep -Seconds 30
          
          # Verify installation
          $metaEditor = "C:\Program Files\MetaTrader 5\MetaEditor64.exe"
          if (Test-Path $metaEditor) {
            Write-Host "MetaTrader 5 installed successfully at: $metaEditor"
          } else {
            Write-Warning "MetaEditor64.exe not found, checking alternate location..."
            if (Test-Path "C:\Program Files\MetaTrader 5\MetaEditor. exe") {
              Write-Host "Found MetaEditor. exe"
            } else {
              Write-Error "MetaEditor not found after installation"
              exit 1
            }
          }

      # 4) Compile EA using MetaEditor CLI
      - name: Compile EA
        run: |
          $metaEditor = "C:/Program Files/MetaTrader 5/MetaEditor64.exe"
          if (-Not (Test-Path $metaEditor)) {
            $fallback = "C:/Program Files/MetaTrader 5/MetaEditor.exe"
            if (Test-Path $fallback) {
              $metaEditor = $fallback
            } else {
              Write-Error "MetaEditor not found at expected locations."
              exit 1
            }
          }

          New-Item -ItemType Directory -Force -Path "logs" | Out-Null

          & "$metaEditor" `
            /compile:"eas/AdaptiveBreakoutAI/src/AdaptiveBreakoutAI.mq5" `
            /log:"logs/build.log"

      # 5) Upload artifacts (artifact upload tolerant, logs always)
      - name: Upload EA build artifact
        if: always()
        uses: actions/upload-artifact@v4
        with: 
          name: AdaptiveBreakoutAI-ex5
          path:  eas/AdaptiveBreakoutAI/src/AdaptiveBreakoutAI.ex5
          if-no-files-found: ignore

      - name: Upload build logs
        if:  always()
        uses: actions/upload-artifact@v4
        with:
          name:  build-logs
          path: logs/
          if-no-files-found: ignore
