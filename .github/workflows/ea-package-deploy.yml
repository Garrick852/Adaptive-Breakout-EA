jobs:
  package-ea:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Debug: list contents of MetaTrader directory
      - name: Debug MetaTrader Directory
        run: |
          if (Test-Path "C:/Program Files/MetaTrader 5/") {
            Get-ChildItem "C:/Program Files/MetaTrader 5/"
          } else {
            Write-Host "MetaTrader 5 directory not found at C:/Program Files/MetaTrader 5/"
          }

      # Find MetaEditor executable
      - name: Find MetaEditor
        run: |
          $metaEditorPaths = @(
            "C:/Program Files/MetaTrader 5/MetaEditor64.exe",
            "C:/Program Files/MetaTrader 5/MetaEditor.exe"
          )

          $found = $false
          foreach ($path in $metaEditorPaths) {
            if (Test-Path $path) {
              Write-Host "Found MetaEditor at $path"
              echo "METAEDITOR_PATH=$path" | Out-File -FilePath $env:GITHUB_ENV -Append
              $found = $true
              break
            }
          }

          if (-not $found) {
            Write-Error "MetaEditor not found in expected locations. Check installation."
            exit 1
          }

      # Compile EA
      - name: Build EA
        run: |
          $metaEditor = $env:METAEDITOR_PATH
          New-Item -ItemType Directory -Force -Path "logs" | Out-Null

          & "$metaEditor" `
            /compile:"eas/AdaptiveBreakoutAI/src/AdaptiveBreakoutAI.mq5" `
            /log:"logs/build.log"

          if (-Not (Test-Path "eas/AdaptiveBreakoutAI/src/AdaptiveBreakoutAI.ex5")) {
            if (Test-Path "logs/build.log") {
              Get-Content logs/build.log
            } else {
              Write-Host "No build log produced."
            }
            Write-Error "EA build failed â€” .ex5 not found."
            exit 1
          }
