name: EA Validation and Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-validate:
    runs-on: windows-latest   # EA compilation requires MetaEditor on Windows

    defaults:
      run: 
        shell: pwsh

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1. Validate configs (optional, tolerant if make is missing)
      - name: Validate EA configs
        continue-on-error: true
        run: |
          if (Get-Command make -ErrorAction SilentlyContinue) {
            make validate-ea-configs
          } else {
            Write-Host "make not found; skipping 'make validate-ea-configs'"
          }

      # 2. Python linting + tests
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          } else {
            Write-Host "requirements.txt not found; skipping dependency install"
          }

      - name: Run Ruff lint
        continue-on-error: true
        run: |
          if (Get-Command ruff -ErrorAction SilentlyContinue) {
            ruff check python/ scripts/
          } else {
            Write-Host "ruff not found; skipping lint check"
          }

      - name: Run pytest
        continue-on-error: true
        run: |
          if (Get-Command pytest -ErrorAction SilentlyContinue) {
            pytest
          } else {
            Write-Host "pytest not found; skipping tests"
          }

      # 3. Compile EA using MetaEditor CLI
      - name: Compile EA
        continue-on-error: true
        run: |
          $metaEditor = "C:/Program Files/MetaTrader 5/MetaEditor64.exe"
          if (-Not (Test-Path $metaEditor)) {
            $fallback = "C:/Program Files/MetaTrader 5/MetaEditor.exe"
            if (Test-Path $fallback) {
              $metaEditor = $fallback
            } else {
              Write-Host "MetaEditor not found at expected locations. Skipping compilation."
              exit 0
            }
          }

          New-Item -ItemType Directory -Force -Path "logs" | Out-Null

          & "$metaEditor" `
            /compile:"eas/AdaptiveBreakoutAI/src/AdaptiveBreakoutAI.mq5" `
            /log:"logs/build.log"

      # 4. Upload artifacts (compiled EA + logs)
      - name: Upload EA build artifact
        if: success()
        uses: actions/upload-artifact@v4
        with: 
          name: AdaptiveBreakoutAI-ex5
          path: eas/AdaptiveBreakoutAI/src/AdaptiveBreakoutAI.ex5
          if-no-files-found: ignore

      - name: Upload build logs
        if:  always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: logs/
          if-no-files-found: ignore
